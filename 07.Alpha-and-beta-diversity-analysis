QIIME 2’s diversity analyses are available through the q2-diversity plugin,
which supports computing alpha and beta diversity metrics,
applying related statistical tests, and generating interactive visualizations.
We’ll first apply the core-metrics-phylogenetic method,
which rarefies a FeatureTable[Frequency] to a user-specified depth,
computes several alpha and beta diversity metrics,
and generates principle coordinates analysis (PCoA) plots using
Emperor for each of the beta diversity metrics.
The metrics computed by default are:

Alpha diversity
Shannon’s diversity index (a quantitative measure of community richness)
Observed Features (a qualitative measure of community richness)
Faith’s Phylogenetic Diversity (a qualitative measure of community richness that incorporates phylogenetic relationships between the features)
Evenness (or Pielou’s Evenness; a measure of community evenness)

Beta diversity
Jaccard distance (a qualitative measure of community dissimilarity)
Bray-Curtis distance (a quantitative measure of community dissimilarity)
unweighted UniFrac distance (a qualitative measure of community dissimilarity that incorporates phylogenetic relationships between the features)
weighted UniFrac distance (a quantitative measure of community dissimilarity that incorporates phylogenetic relationships between the features)

An important parameter that needs to be provided to this script is --p-sampling-depth,
which is the even sampling (i.e. rarefaction) depth.
Because most diversity metrics are sensitive to different sampling depths
across different samples, this script will randomly subsample the counts from each
sample to the value provided for this parameter. For example,
if you provide --p-sampling-depth 500, this step will subsample the
counts in each sample without replacement so that each sample in the resulting
table has a total count of 500. If the total count for any sample(s) are smaller
than this value, those samples will be dropped from the diversity analysis.
Choosing this value is tricky. We recommend making your choice by reviewing the
information presented in the table.qzv file that was created above.
Choose a value that is as high as possible (so you retain more sequences per sample)
while excluding as few samples as possible.

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree.qza \
  --i-table ../table.qza \
  --p-sampling-depth 57962 (table.qzv lowest read-frequency) \
  --m-metadata-file ../metadata_16S_adult.txt \
  --output-dir core-metrics-results

#Chao1を計算
qiime diversity alpha \
--i-table rarefied_table.qza \
--p-metric chao1 \
--o-alpha-diversity chao1_vector.qza

#各種α多様性指数とメタデータの関連解析
qiime diversity alpha-group-significance \
--i-alpha-diversity observed_features_vector.qza \
--m-metadata-file ../../metadata_16S.txt \#directoryを書く
--o-visualization observed_features-group-significance.qzv

qiime diversity alpha-group-significance \
--i-alpha-diversity chao1_vector.qza \
--m-metadata-file ~/Downloads/gut-microbiome-analysis/metadata_16S.txt \
--o-visualization chao1-group-significance.qzv


qiime diversity alpha-group-significance \
--i-alpha-diversity shannon_vector.qza \
--m-metadata-file ~/Downloads/gut-microbiome-analysis/metadata_16S.txt \
--o-visualization shannon-group-significance.qzv

qiime diversity alpha-group-significance \
--i-alpha-diversity faith_pd_vector.qza \
--m-metadata-file ~/Downloads/gut-microbiome-analysis/metadata_16S.txt \
--o-visualization faith-pd-group-significance.qzv

qiime diversity alpha-group-significance \
--i-alpha-diversity evenness_vector.qza \
--m-metadata-file ../../metadata_16S_adult.txt \
--o-visualization evenness-group-significance.qzv 


Unweighted UniFrac considers only the presence or absence of taxa,
while weighted UniFrac takes into account the relative abundance of shared taxa

qiime diversity beta-group-significance \
--i-distance-matrix weighted_unifrac_distance_matrix.qza \
--m-metadata-file ../../metadata_16S_adult.txt \
--m-metadata-column Group \
--o-visualization weighted-unifrac-group-significance.qzv \
--p-pairwise

qiime diversity beta-group-significance \
--i-distance-matrix unweighted_unifrac_distance_matrix.qza \
--m-metadata-file ../../metadata_16S_adult.txt \
--m-metadata-column Group \
--o-visualization unweighted-unifrac-group-significance.qzv \
--p-pairwise

#wighted_unifrac_emperor.qzv
・UniFrac距離に基づいて計算された距離行列の可視化結果 (主成分分析)


#weighted-unifrac-group-significance.qzv
・PERMANOVAで解析


生データの取り出し
・β
qiime tools export \
--input-path weighted_unifrac_pcoa_results.qza \
--output-path weighted_unifrac_pcoa_results

・α
qiime tools export \
--input-path shannon_vector.qza \
--output-path shannon_vector_results

qiime tools export \
--input-path chao1_vector.qza \
--output-path chao1_vector_results

qiime tools export \
--input-path faith_pd_vector.qza \
--output-path faith_pd_vector_results
